name: Build Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Permite ejecución manual

env:
  IMAGE_NAME: calculadora-backend
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Iniciar sesión en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extraer metadatos (etiquetas, etiquetas) para Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Construir imagen Docker localmente para health check
        uses: docker/build-push-action@v5
        with:
          context: ./CalculatorBackendSpringbootProject
          file: ./CalculatorBackendSpringbootProject/Dockerfile
          platforms: linux/amd64
          push: false
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/image.tar

      - name: Cargar imagen Docker
        run: docker load -i /tmp/image.tar

      - name: Ejecutar contenedor para health check
        run: |
          docker run -d -p 8080:8080 --name calculadora-backend-test ${{ env.IMAGE_NAME }}:test
          echo "Contenedor iniciado, esperando a que la aplicación esté lista..."

      - name: Esperar a que la aplicación esté lista
        run: |
          echo "Esperando a que el servicio esté disponible..."
          timeout=60
          counter=0
          
          # Intentar múltiples endpoints posibles
          while [ $counter -lt $timeout ]; do
            # Intentar /actuator/health primero (si tienen Actuator)
            if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "✅ Servicio disponible en /actuator/health"
              break
            fi
            # Intentar raíz
            if curl -f http://localhost:8080/ 2>/dev/null; then
              echo "✅ Servicio disponible en /"
              break
            fi
            # Intentar cualquier respuesta HTTP (incluso 404 significa que el servidor está corriendo)
            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ 2>/dev/null || echo "000")
            if [ "$http_code" != "000" ] && [ "$http_code" != "" ]; then
              echo "✅ Servicio respondiendo (código HTTP: $http_code)"
              break
            fi
            
            echo "Intento $counter/$timeout: Esperando servicio..."
            sleep 2
            counter=$((counter + 2))
          done
          
          if [ $counter -ge $timeout ]; then
            echo "❌ Timeout: El servicio no respondió a tiempo"
            docker logs calculadora-backend-test
            exit 1
          fi

      - name: Health Check - Verificar endpoint
        run: |
          echo "Realizando health check..."
          
          # Intentar /actuator/health primero (recomendado)
          health_endpoint=""
          if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
            health_endpoint="/actuator/health"
            echo "Usando endpoint: /actuator/health"
          else
            # Si no hay Actuator, usar raíz
            health_endpoint="/"
            echo "Usando endpoint: / (Actuator no disponible)"
          fi
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080$health_endpoint || echo "000")
          body=$(curl -s http://localhost:8080$health_endpoint || echo "")
          
          echo "Código de respuesta HTTP: $response"
          echo "Cuerpo de respuesta: $body"
          
          if [ "$response" != "200" ]; then
            echo "❌ Health check falló: Código HTTP $response (esperado 200)"
            docker logs calculadora-backend-test
            docker stop calculadora-backend-test
            docker rm calculadora-backend-test
            exit 1
          fi
          
          # Verificar contenido de respuesta
          if echo "$body" | grep -q '"status":"UP"'; then
            echo "✅ Health check exitoso: Servicio respondió 200 OK con status UP"
          elif echo "$body" | grep -qi "ok"; then
            echo "✅ Health check exitoso: Servicio respondió 200 OK"
          elif [ "$response" = "200" ]; then
            echo "✅ Health check exitoso: Servicio respondió 200 OK"
          else
            echo "❌ Health check falló: Respuesta inesperada"
            docker logs calculadora-backend-test
            docker stop calculadora-backend-test
            docker rm calculadora-backend-test
            exit 1
          fi

      - name: Detener contenedor de prueba
        if: always()
        run: |
          docker stop calculadora-backend-test || true
          docker rm calculadora-backend-test || true

      - name: Construir y publicar imagen Docker (multi-arquitectura)
        uses: docker/build-push-action@v5
        with:
          context: ./CalculatorBackendSpringbootProject
          file: ./CalculatorBackendSpringbootProject/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Mostrar información de la imagen
        run: |
          echo "✅ Imagen construida y verificada exitosamente:"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Puedes acceder a la imagen en: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"

